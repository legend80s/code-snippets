# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH

# Path to your oh-my-zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time oh-my-zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
ZSH_THEME="robbyrussell"

# Set list of themes to pick from when loading at random
# Setting this variable when ZSH_THEME=random will cause zsh to load
# a theme from this variable instead of looking in $ZSH/themes/
# If set to an empty array, this variable will have no effect.
# ZSH_THEME_RANDOM_CANDIDATES=( "robbyrussell" "agnoster" )

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
# zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
# ENABLE_CORRECTION="true"

# Uncomment the following line to display red dots whilst waiting for completion.
# You can also set it to another string to have that shown instead of the default red dots.
# e.g. COMPLETION_WAITING_DOTS="%F{yellow}waiting...%f"
# Caution: this setting can cause issues with multiline prompts in zsh < 5.7.1 (see #5765)
# COMPLETION_WAITING_DOTS="true"

# Uncomment the following line if you want to disable marking untracked files
# under VCS as dirty. This makes repository status check for large repositories
# much, much faster.
# DISABLE_UNTRACKED_FILES_DIRTY="true"

# Uncomment the following line if you want to change the command execution time
# stamp shown in the history command output.
# You can set one of the optional three formats:
# "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
# or set a custom format using the strftime function format specifications,
# see 'man strftime' for details.
# HIST_STAMPS="mm/dd/yyyy"

# Would you like to use another custom folder than $ZSH/custom?
# ZSH_CUSTOM=/path/to/new-custom-folder

# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(
  git
  zsh-syntax-highlighting
  zsh-autosuggestions
)

source $ZSH/oh-my-zsh.sh

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='mvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# Set personal aliases, overriding those provided by oh-my-zsh libs,
# plugins, and themes. Aliases can be placed here, though oh-my-zsh
# users are encouraged to define aliases within the ZSH_CUSTOM folder.
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"

eval "$(starship init zsh)"

# ERR_PNPM_NO_GLOBAL_BIN_DIR  Unable to find the global bin directory
export PNPM_HOME="E:\pnpm"
export PATH=/e/pnpm:/e/pnpm/bun:/c/Users/liuchuanzong/.bun/bin:$PATH
alias p="pnpm"

alias zshrc="code ~/.zshrc"
alias sz="source ~/.zshrc"

alias gst="git status"
alias st="git status"
alias gp="git push"
alias gl="git pull"
# alias gcam="git commit -am"
alias gcam="gaa && git commit -am"
alias gcmsg="git commit -m"
alias gco="git checkout"

gcol() {
  git checkout "$1" && git pull
}

alias gaa="git add -A"
alias gcm="git checkout main || git checkout master && git pull"
alias gcmain="git checkout main"
alias gcmian="git checkout main"
alias gmm="gcm && gco - && git merge origin main"
alias gd="git diff"
alias d="git diff"

gclone() {
  git clone "$1" && cd $(extract_repo_name "$1") && code .
}

# Open current repository url in browser.
# replace
# https://git.corp.com/project/path.git
# to
# https://git.corp.com/project/path
# and open it in browser using `start` in Windows
alias repo-url="git remote get-url origin | awk '{ gsub(/^git@|\.git$/, \"\"); printf \$1 }' | awk '{ gsub(/:/, \"/\"); printf \$1 }'"
alias open-repo="repo-url | xargs start"
alias open="start"

function open_npm() {
  start 'https://www.npmjs.com/package/'$(grep name package.json | awk -F '"' '{ print $4 }')
}
alias open-npm="open_npm"

# extract git repository name from string "https://github.com/zsh-users/zsh-syntax-highlighting.git"
# input https://github.com/zsh-users/zsh-syntax-highlighting.git
# output zsh-syntax-highlighting
extract_repo_name() {
    local url="$1"
    # 使用sed和正则表达式去除.git后缀，并提取最后一部分
    echo "$url" | sed 's|.*/\(.*\)\.git|\1|'
}

alias dev="bun run dev"
alias mock="bun run mock"
alias lint="bun run lint"
alias b="bun run build"
alias build="bun run build"
alias t="bun run test"
alias ci="bun run ci"
alias bunx="bun x"

alias c="code ."
alias pn='pnpm'

alias use16='nvm use 16'
alias use22='nvm use 22'

# touch a new file under nested directory
# touchr /path/to/file.ts -> mkdir -p /path/to && touch /path/to/file.ts
# and open it in vscode
# and if file name is `.html` then open it in browser.
# and write into a template.
touchr() {
    mkdir -p "$(dirname "$1")" && touch "$1" && code "$1"

    # 如果文件名 `.html` 结尾则使用浏览器打开。
    if [[ "$1" == *.html ]]; then
      local basename=$(basename "$1", '.html')

      echo '<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>'$basename' Quick Start</title>
</head>
<body>
  <h1>'$basename' Quick Start</h1>
</body>
</html>' > "$1"
      start "$1"
    fi
}

# change_node_version_per_project begin
trim() {
    # trim leading and trailing whitespace(\s\r\t\n\v)
    # https://stackoverflow.com/questions/369758/how-to-trim-whitespace-from-a-bash-variable
    echo $1 | xargs
}

# shortcut for nvm use $(cat .nvmrc)
# if not change automaticly, use `nvmuse` change it manually
# nvmuse() {
#   change_node_version_per_project
# }

change_node_version_per_project() {
    local nvmrc_path="./.nvmrc"

    if [[ -f "$nvmrc_path" ]]; then
        local node_version=$(grep -oP '\d+(\.\d+)?(\.\d+)?' .nvmrc | head -n1)

        echo '---------------------------------------'
        echo "node_version in .nvmrc is $node_version"
        echo '---------------------------------------'

        cur_ver=$(node -v)
        if [[ $cur_ver =~ ^v$node_version\. ]]; then
          echo 'Current node version "'$cur_ver'" matches "'$node_version'", no need to change.'
        else
          nvm use "$node_version" || use_from_pkg_json
        fi
    else
        # echo "No .nvmrc file found in the current directory."
        use_from_pkg_json
    fi
}

use_from_pkg_json() {
    if [[ -f "./package.json" ]]; then
      local node_version=$(grep -A 2 engines package.json | grep -oP '[0-9]+' | head -n1);
      # "node": ">=18
      local hasLargerThanOrEqualSign=$(grep -A 2 engines package.json | grep -oP '"node": ">=?[0-9]+' | head -n1);

      echo '---------------------------------------------'
      echo "engines.node in package.json is $node_version";
      echo '---------------------------------------------'

      # local pkg_json_path="package.json"
      # local node_version=$(jq -r '.engines.node' "$pkg_json_path" | cut -d' ' -f1)

      if [ -z "$node_version" ]; then
          echo "No node version specified in package.json."
      else
          # if hasLargerThanOrEqualSign not empty then use `nvm use latest`
          if [ -n "$hasLargerThanOrEqualSign" ]; then
              nvm use latest
          else
              nvm use "$node_version"
          fi
      fi
  fi
}

# call it when you change directory
cd() {
    builtin cd "$@" && change_node_version_per_project
}

alias nvmuse='change_node_version_per_project'

change_node_version_per_project
# change_node_version_per_project end

alias why='yarn why'

alias md='mkdir -p'

alias 。。='cd ..'

alias temp='cd /f/temp'
alias tenent='tenant'


alias github='cd /f/workspace/github'

alias hosts="echo 'c:\\windows\\system32\\drivers\\etc'"

alias regget='npm config get registry'
alias regnpm='npm config set registry https://registry.npmjs.org && regget'
alias npmreg='regnpm'


alias regtaobao='npm config set registry https://registry.npmmirror.com && regget'
alias taobaoreg='regtaobao'

alias resetreg='regnpm'
alias getreg='npm config get registry'
alias npmreg='regnpm'


# git alias
gcamp() {
  # echo $@
  git commit -am "$@" && git push
}

alias last-commit-id="git log --oneline -n 1 | awk '{ printf \$1 }'"
alias last-commit="last-commit-id | clip"

# https://git.corp.com/project/path/-/commit/66388b372b2e85e9a8d0b06d30866f4be3fdd663
last-commit-url() {
  local url=$(repo-url);
  local id=$(last-commit-id);

  echo -n "${url}/-/commit/${id}"
}

# 生活
alias 天气="curl 'wttr.in/jiaxing'"
alias tq="curl 'wttr.in/jiaxing'"
alias tqhz="curl 'wttr.in/hangzhou'"
alias tqld="curl 'wttr.in/loudi'"

# jump to workspace
# tenant

# tq
. "$HOME/.local/bin/env"
